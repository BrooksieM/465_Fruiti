<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Become a Seller - Payment</title>
<link rel="stylesheet" href="/css/standardLayout.css">
<link rel="stylesheet" href="/css/footer/footer.css">
<link rel="stylesheet" href="/css/become-a-seller/payment.css">
</head>

<body>
  <div class="navbar">
<div class="logo">
      <a href="/">
        <img src="../images/fruiti.png" alt="Fruiti logo - Click to go home" />
      </a>
    </div>
    <div class="auth-buttons" id="authButtons">
      <button class="login-btn" onclick="location.href='/login'">Log In</button>
      <button class="signup-btn" onclick="location.href='/signup'">Sign Up</button>
    </div>
  </div>

  <nav class="nav-links">
    <a href="/">Home</a>
    <a href="/become-seller" class="active">Become a Seller</a>
    <a href="nutrition">Nutrition</a>
    <a href="/recipe">Recipes</a>
    <a href="/aboutus">About Us</a>
  </nav>

  <div class="black-bar"></div>

  <div class="payment-container">
    <!-- Left Side - Payment Form -->
    <div class="payment-section">
      <h2 class="section-title">Complete Your Purchase</h2>
      
      <!-- Account Status Notice -->
      <div class="account-notice" id="accountNotice">
        <p><strong>New to Fruiti?</strong> Create your account and become a seller in one step!</p>
      </div>

      <form id="paymentForm">
        <!-- Email (always visible) -->
        <div class="form-group">
          <label for="email">Email Address *</label>
          <input type="email" id="email" name="email" required>
        </div>

        <!-- Account Information (only for non-logged in users) -->
        <div id="accountSection">
          <div class="form-group">
            <label for="handle">Username (Handle) *</label>
            <input type="text" id="handle" name="handle" placeholder="e.g., john_fruits" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="password">Password *</label>
              <input type="password" id="password" name="password" required>
            </div>
            <div class="form-group">
              <label for="confirmPassword">Confirm Password *</label>
              <input type="password" id="confirmPassword" name="confirmPassword" required>
            </div>
          </div>
        </div>

        <!-- Stand Information -->
        <h3 style="color: #017d49; font-size: 20px; margin: 32px 0 16px;">Stand Information</h3>
        
        <div class="form-group">
          <label for="standName">Stand Name *</label>
          <input type="text" id="standName" name="standName" maxlength="50" placeholder="e.g., Johnson's Fresh Fruit Stand" required>
        </div>

        <div class="form-group">
          <label for="standDescription">Stand Description</label>
          <textarea id="standDescription" name="standDescription" rows="3" placeholder="Tell customers about your stand..."></textarea>
        </div>

        <div class="form-group">
          <label for="phone_number">Phone Number *</label>
          <input type="tel" id="phone_number" name="phone_number" maxlength="14" required>
        </div>

        <div class="form-group">
          <label for="standAddress">Stand Address *</label>
          <input type="text" id="standAddress" name="standAddress" placeholder="Street address" maxlength="70" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="city">City *</label>
            <input type="text" id="city" name="city" required>
          </div>
          <div class="form-group">
            <label for="state">State *</label>
            <select id="state" name="state" required>
              <option value="">Select a state</option>
              <option value="AL">Alabama</option>
              <option value="AK">Alaska</option>
              <option value="AZ">Arizona</option>
              <option value="AR">Arkansas</option>
              <option value="CA">California</option>
              <option value="CO">Colorado</option>
              <option value="CT">Connecticut</option>
              <option value="DE">Delaware</option>
              <option value="FL">Florida</option>
              <option value="GA">Georgia</option>
              <option value="HI">Hawaii</option>
              <option value="ID">Idaho</option>
              <option value="IL">Illinois</option>
              <option value="IN">Indiana</option>
              <option value="IA">Iowa</option>
              <option value="KS">Kansas</option>
              <option value="KY">Kentucky</option>
              <option value="LA">Louisiana</option>
              <option value="ME">Maine</option>
              <option value="MD">Maryland</option>
              <option value="MA">Massachusetts</option>
              <option value="MI">Michigan</option>
              <option value="MN">Minnesota</option>
              <option value="MS">Mississippi</option>
              <option value="MO">Missouri</option>
              <option value="MT">Montana</option>
              <option value="NE">Nebraska</option>
              <option value="NV">Nevada</option>
              <option value="NH">New Hampshire</option>
              <option value="NJ">New Jersey</option>
              <option value="NM">New Mexico</option>
              <option value="NY">New York</option>
              <option value="NC">North Carolina</option>
              <option value="ND">North Dakota</option>
              <option value="OH">Ohio</option>
              <option value="OK">Oklahoma</option>
              <option value="OR">Oregon</option>
              <option value="PA">Pennsylvania</option>
              <option value="RI">Rhode Island</option>
              <option value="SC">South Carolina</option>
              <option value="SD">South Dakota</option>
              <option value="TN">Tennessee</option>
              <option value="TX">Texas</option>
              <option value="UT">Utah</option>
              <option value="VT">Vermont</option>
              <option value="VA">Virginia</option>
              <option value="WA">Washington</option>
              <option value="WV">West Virginia</option>
              <option value="WI">Wisconsin</option>
              <option value="WY">Wyoming</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="zipcode">ZIP Code *</label>
          <input type="text" id="zipcode" name="zipcode" placeholder="12345" maxlength="5" required>
        </div>

        <!-- Payment Information -->
        <h3 style="color: #017d49; font-size: 20px; margin: 32px 0 16px;">Payment Information</h3>

        <div class="payment-methods">
          <div class="payment-method active" data-method="card">
            <div class="card-icons">üí≥</div>
            <div>Credit Card</div>
          </div>
          <div class="payment-method" data-method="paypal">
            <div class="card-icons">üÖøÔ∏è</div>
            <div>PayPal</div>
          </div>
        </div>

        <div id="cardPaymentSection">
          <div class="form-group">
            <label for="cardNumber">Card Number *</label>
            <input type="text" id="cardNumber" name="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="cardName">Name on Card *</label>
              <input type="text" id="cardName" name="cardName" required>
            </div>
            <div class="form-group">
              <label for="expiryDate">Expiry Date *</label>
              <input type="text" id="expiryDate" name="expiryDate" placeholder="MM/YY" maxlength="5" required>
            </div>
          </div>

          <div class="form-group">
            <label for="cvv">CVV *</label>
            <input type="text" id="cvv" name="cvv" placeholder="123" maxlength="3" required>
          </div>
        </div>

        <div class="terms-checkbox">
          <input type="checkbox" id="terms" name="terms" required>
          <label for="terms">
            I agree to the <a href="/terms">Terms of Service</a> and <a href="/privacy">Privacy Policy</a>. 
            I understand my subscription will auto-renew and I can cancel anytime.
          </label>
        </div>

        <button type="submit" class="submit-btn">Complete Purchase & Become a Seller</button>
        
        <p class="security-notice">Your payment information is secure and encrypted by Stripe!</p>
      </form>
    </div>

    <!-- Right Side - Order Summary -->
    <div class="payment-section">
      <h2 class="section-title">Order Summary</h2>
      
      <div class="order-summary">
        <div class="plan-details">
          <div>
            <div class="plan-name-display" id="selectedPlanName">3 Months Plan</div>
            <div class="savings-display" id="savingsDisplay">üí∞ Save 33%</div>
          </div>
          <div class="plan-price-display" id="selectedPlanPrice">$10</div>
        </div>
        
        <div class="features-summary">
          <h4>What's Included:</h4>
          <ul id="planFeaturesList">
            <li>Everything in Monthly</li>
            <li>Priority customer support</li>
            <li>Featured stand placement</li>
            <li>Advanced analytics</li>
            <li>Photo gallery (up to 10 photos)</li>
            <li>Social media integration</li>
          </ul>
        </div>
      </div>

      <div class="total-section">
        <div class="total-row">
          <span>Subtotal</span>
          <span id="subtotal">$10.00</span>
        </div>
        <div class="total-row">
          <span>Tax</span>
          <span id="tax">$0.00</span>
        </div>
        <div class="total-row final">
          <span>Total</span>
          <span id="total">$10.00</span>
        </div>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>
  <script src="/scripts/footer.js"></script>
  <script src="/scripts/navigationForLoggedInUser.js"></script>

  <script>
    // Get plan details from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const plan = urlParams.get('plan') || '3month';

    const plans = {
      'monthly': {
        name: 'Monthly Plan',
        price: '$1.99',
        period: '/mo',
        savings: null,
        features: [
          'List your fruit stand location',
          'Update inventory daily',
          'Customer reviews & ratings',
          // 'Basic analytics dashboard',
          'Email support'
        ],
        amount: 1.99
      },
      '3month': {
        name: '3 Months Plan',
        price: '$4.99',
        period: '/3mo',
        savings: 'üí∞ Save 17%',
        features: [
          'Everything in Monthly',
          'Priority customer support',
          // 'Featured stand placement',
          // 'Advanced analytics',
          'Photo gallery (up to 10 photos)',
          'Social media integration'
        ],
        amount: 4.99
      },
      '6month': {
        name: '6 Months Plan',
        price: '$7.99',
        period: '/6mo',
        savings: 'üéâ Save 33%',
        features: [
          'Everything in 3 Months',
          'Premium stand badge',
          'Unlimited photos',
          // 'Custom stand URL',
          // 'Priority listing in searches',
          // 'Dedicated account manager',
          'Promotional campaigns'
        ],
        amount: 7.99
      }
    };

    const selectedPlan = plans[plan];

    // Update UI with selected plan
    document.getElementById('selectedPlanName').textContent = selectedPlan.name;
    document.getElementById('selectedPlanPrice').textContent = selectedPlan.price;
    
    if (selectedPlan.savings) {
      document.getElementById('savingsDisplay').textContent = selectedPlan.savings;
      document.getElementById('savingsDisplay').style.display = 'inline-block';
    } else {
      document.getElementById('savingsDisplay').style.display = 'none';
    }

    // Update features list
    const featuresList = document.getElementById('planFeaturesList');
    featuresList.innerHTML = selectedPlan.features.map(feature => `<li>${feature}</li>`).join('');

    // Update totals
    const subtotal = selectedPlan.amount;
    const tax = 0; // You can calculate tax based on location
    const total = subtotal + tax;

    document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('tax').textContent = `$${tax.toFixed(2)}`;
    document.getElementById('total').textContent = `$${total.toFixed(2)}`;

    // Check if user is logged in
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    const userId = localStorage.getItem('userId');

    if (isLoggedIn && userId) {
      // User is logged in - hide account creation fields
      document.getElementById('accountSection').style.display = 'none';
      document.getElementById('accountNotice').innerHTML = '<p><strong>Upgrade to Seller Account</strong> Complete your payment to start selling!</p>';

      // Remove required attribute from hidden fields
      document.getElementById('handle').required = false;
      document.getElementById('password').required = false;
      document.getElementById('confirmPassword').required = false;

      // Fetch user email to pre-fill
      fetch(`/api/accounts/${userId}`)
        .then(response => response.json())
        .then(user => {
          if (user && user.email) {
            document.getElementById('email').value = user.email;
            document.getElementById('email').readOnly = true;
          }
        })
        .catch(err => console.error('Error fetching user:', err));
    } else {
      // Make sure all account fields are required
      document.getElementById('email').required = true;
      document.getElementById('handle').required = true;
      document.getElementById('password').required = true;
      document.getElementById('confirmPassword').required = true;
    }

    // Payment method toggle
    document.querySelectorAll('.payment-method').forEach(method => {
      method.addEventListener('click', function() {
        document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
        this.classList.add('active');
        
        const selectedMethod = this.dataset.method;
        if (selectedMethod === 'paypal') {
          document.getElementById('cardPaymentSection').style.display = 'none';
        } else {
          document.getElementById('cardPaymentSection').style.display = 'block';
        }
      });
    });

    // Card number formatting
    document.getElementById('cardNumber').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\s/g, '');
      let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
      e.target.value = formattedValue;
    });

    // Expiry date formatting
    document.getElementById('expiryDate').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length >= 2) {
        value = value.slice(0, 2) + '/' + value.slice(2, 4);
      }
      e.target.value = value;
    });

    // ZIP code formatting (numbers only)
    document.getElementById('zipcode').addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/\D/g, '');
    });

    // Phone number formatting (XXX) XXX-XXXX
    document.getElementById('phone_number').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');

      if (value.length > 0) {
        if (value.length <= 3) {
          value = value;
        } else if (value.length <= 6) {
          value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
        } else {
          value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
        }
      }

      e.target.value = value;
    });

    // CVV formatting (numbers only, max 3 digits)
    document.getElementById('cvv').addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, 3);
    });

    // Form submission
    document.getElementById('paymentForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      // Validate passwords match if account section is visible
      const accountSectionVisible = document.getElementById('accountSection').style.display !== 'none';
      if (accountSectionVisible) {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (password !== confirmPassword) {
          alert('Passwords do not match!');
          return;
        }
      }

      // Validate state is selected
      const state = document.getElementById('state').value;
      if (!state) {
        alert('Please select a state');
        return;
      }

      // Validate ZIP code
      const zipcode = document.getElementById('zipcode').value;
      if (zipcode.length !== 5) {
        alert('Please enter a valid 5-digit ZIP code');
        return;
      }

      // Get form data
      const formData = {
        email: document.getElementById('email').value,
        subscriptionType: plan,
        standName: document.getElementById('standName').value,
        standDescription: document.getElementById('standDescription').value,
        phone_number: document.getElementById('phone_number').value,
        standAddress: document.getElementById('standAddress').value,
        city: document.getElementById('city').value,
        state: state,
        zipcode: zipcode,
        paymentMethod: document.querySelector('.payment-method.active').dataset.method
      };

      // Add account fields for new users
      if (accountSectionVisible) {
        formData.password = document.getElementById('password').value;
        formData.handle = document.getElementById('handle').value;
      }

      // Disable submit button
      const submitBtn = document.querySelector('.submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';

      try {
        // Send data to backend
        const response = await fetch('/api/purchase-seller-subscription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (response.ok) {
          alert(`Success! ${result.message}\n\nYour subscription is active until ${new Date(result.subscriptionEnd).toLocaleDateString()}`);

          // Store user info in localStorage (temporary until proper auth is implemented)
          localStorage.setItem('userId', result.userId);
          localStorage.setItem('isLoggedIn', 'true');

          // Fetch updated user data with is_seller: true
          try {
            const userResponse = await fetch(`/api/accounts/${result.userId}`);
            if (userResponse.ok) {
              const userData = await userResponse.json();
              localStorage.setItem('user', JSON.stringify(userData));
              console.log('Updated user data stored in localStorage:', userData);
            }
          } catch (error) {
            console.error('Error fetching user data:', error);
          }

          // Redirect to homepage or seller dashboard
          window.location.href = '/';
        } else {
          alert(`Error: ${result.error}`);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Complete Purchase & Become a Seller';
        }
      } catch (error) {
        console.error('Purchase error:', error);
        alert('An error occurred while processing your purchase. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Complete Purchase & Become a Seller';
      }
    });
  </script>
</body>
</html>