<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Extend Subscription - Payment</title>
<link rel="stylesheet" href="/css/standardLayout.css">
<link rel="stylesheet" href="/css/footer/footer.css">
<link rel="stylesheet" href="/css/become-a-seller/payment.css">
</head>

<body>
  <div class="navbar">
<div class="logo">
      <a href="/">
        <img src="../images/fruiti.png" alt="Fruiti logo - Click to go home" />
      </a>
    </div>
    <div class="auth-buttons" id="authButtons"></div>
  </div>

  <nav class="nav-links">
    <a href="/">Home</a>
    <a href="/become-seller" class="active">Become a Seller</a>
    <a href="nutrition">Nutrition</a>
    <a href="/recipe">Recipes</a>
    <a href="/aboutus">About Us</a>
  </nav>

  <div class="black-bar"></div>

  <div class="payment-container">
    <!-- Left Side - Payment Form -->
    <div class="payment-section">
      <h2 class="section-title">Extend Your Subscription</h2>
      
      <div class="account-notice">
        <p><strong>Subscription Extension</strong> Complete your payment to extend your fruit stand subscription!</p>
      </div>

      <form id="paymentForm">
        <!-- Email (read-only for logged in users) -->
        <div class="form-group">
          <label for="email">Email Address *</label>
          <input type="email" id="email" name="email" required>
        </div>

        <!-- Payment Information -->
        <h3 style="color: #017d49; font-size: 20px; margin: 32px 0 16px;">Payment Information</h3>

        <div class="payment-methods">
          <div class="payment-method active" data-method="card">
            <div class="card-icons">üí≥</div>
            <div>Credit Card</div>
          </div>
          <div class="payment-method" data-method="paypal">
            <div class="card-icons">üÖøÔ∏è</div>
            <div>PayPal</div>
          </div>
        </div>

        <div id="cardPaymentSection">
          <div class="form-group">
            <label for="card-element">Credit or Debit Card *</label>
            <div id="card-element" style="padding: 12px; border: 1px solid #ddd; border-radius: 4px; background: white;">
              <!-- Stripe Elements will insert the card input here -->
            </div>
            <div id="card-errors" role="alert" style="color: #e74c3c; margin-top: 8px; font-size: 14px;"></div>
          </div>
        </div>

        <div class="terms-checkbox">
          <input type="checkbox" id="terms" name="terms" required>
          <label for="terms">
            I agree to the <a href="/terms">Terms of Service</a> and <a href="/privacy">Privacy Policy</a>. 
            I understand my subscription will auto-renew and I can cancel anytime.
          </label>
        </div>

        <button type="submit" class="submit-btn">Complete Payment & Extend Subscription</button>
        
        <p class="security-notice">Your payment information is secure and encrypted by Stripe!</p>
      </form>
    </div>

    <!-- Right Side - Order Summary -->
    <div class="payment-section">
      <h2 class="section-title">Order Summary</h2>
      
      <div class="order-summary">
        <div class="plan-details">
          <div>
            <div class="plan-name-display" id="selectedPlanName">3 Months Plan</div>
            <div class="savings-display" id="savingsDisplay">üí∞ Save 33%</div>
          </div>
          <div class="plan-price-display" id="selectedPlanPrice">$10</div>
        </div>
        
        <div class="features-summary">
          <h4>What's Included:</h4>
          <ul id="planFeaturesList">
            <li>Everything in Monthly</li>
            <li>Priority customer support</li>
            <li>Photo gallery (up to 10 photos)</li>
            <li>Social media integration</li>
          </ul>
        </div>
      </div>

      <div class="total-section">
        <div class="total-row">
          <span>Subtotal</span>
          <span id="subtotal">$10.00</span>
        </div>
        <div class="total-row">
          <span>Tax</span>
          <span id="tax">$0.00</span>
        </div>
        <div class="total-row final">
          <span>Total</span>
          <span id="total">$10.00</span>
        </div>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>
  <script src="/scripts/footer.js"></script>
  <script src="/scripts/navigationForLoggedInUser.js"></script>
  <script src="https://js.stripe.com/v3/"></script>

  <script>
    // Get plan details from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const plan = urlParams.get('plan') || '3month';

    const plans = {
      'monthly': {
        name: 'Monthly Plan',
        price: '$1.99',
        period: '/mo',
        savings: null,
        features: [
          'List your fruit stand location',
          'Update inventory daily',
          'Customer reviews & ratings',
          'Email support'
        ],
        amount: 1.99
      },
      '3month': {
        name: '3 Months Plan',
        price: '$4.99',
        period: '/3mo',
        savings: 'üí∞ Save 17%',
        features: [
          'Everything in Monthly',
          'Priority customer support',
          'Photo gallery (up to 10 photos)',
          'Social media integration'
        ],
        amount: 4.99
      },
      '6month': {
        name: '6 Months Plan',
        price: '$7.99',
        period: '/6mo',
        savings: 'üéâ Save 33%',
        features: [
          'Everything in 3 Months',
          'Premium stand badge',
          'Unlimited photos',
          'Promotional campaigns'
        ],
        amount: 7.99
      }
    };

    const selectedPlan = plans[plan];

    // Update UI with selected plan
    document.getElementById('selectedPlanName').textContent = selectedPlan.name;
    document.getElementById('selectedPlanPrice').textContent = selectedPlan.price;
    
    if (selectedPlan.savings) {
      document.getElementById('savingsDisplay').textContent = selectedPlan.savings;
      document.getElementById('savingsDisplay').style.display = 'inline-block';
    } else {
      document.getElementById('savingsDisplay').style.display = 'none';
    }

    // Update features list
    const featuresList = document.getElementById('planFeaturesList');
    featuresList.innerHTML = selectedPlan.features.map(feature => `<li>${feature}</li>`).join('');

    // Update totals
    const subtotal = selectedPlan.amount;
    const tax = 0;
    const total = subtotal + tax;

    document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('tax').textContent = `$${tax.toFixed(2)}`;
    document.getElementById('total').textContent = `$${total.toFixed(2)}`;

    // Check if user is logged in
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    const userId = localStorage.getItem('userId');

    if (isLoggedIn && userId) {
      // Fetch user email to pre-fill
      fetch(`/api/accounts/${userId}`)
        .then(response => response.json())
        .then(user => {
          if (user && user.email) {
            document.getElementById('email').value = user.email;
            document.getElementById('email').readOnly = true;
          }
        })
        .catch(err => console.error('Error fetching user:', err));
    }

    // Initialize Stripe
    let stripe, elements, cardElement;

    // Fetch Stripe publishable key and initialize Stripe Elements
    fetch('/api/stripe-publishable-key')
      .then(response => response.json())
      .then(data => {
        stripe = Stripe(data.publishableKey);
        elements = stripe.elements();

        // Create and mount the card Element
        cardElement = elements.create('card', {
          style: {
            base: {
              fontSize: '16px',
              color: '#32325d',
              fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
              '::placeholder': {
                color: '#aab7c4'
              }
            },
            invalid: {
              color: '#e74c3c'
            }
          }
        });
        cardElement.mount('#card-element');

        // Handle real-time validation errors from the card Element
        cardElement.on('change', function(event) {
          const displayError = document.getElementById('card-errors');
          if (event.error) {
            displayError.textContent = event.error.message;
          } else {
            displayError.textContent = '';
          }
        });
      })
      .catch(error => {
        console.error('Error loading Stripe:', error);
        alert('Failed to load payment system. Please refresh the page.');
      });

    // Payment method toggle
    document.querySelectorAll('.payment-method').forEach(method => {
      method.addEventListener('click', function() {
        document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
        this.classList.add('active');

        const selectedMethod = this.dataset.method;
        if (selectedMethod === 'paypal') {
          document.getElementById('cardPaymentSection').style.display = 'none';
        } else {
          document.getElementById('cardPaymentSection').style.display = 'block';
        }
      });
    });

    // Form submission
    document.getElementById('paymentForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const userData = localStorage.getItem('user');
      if (!userData) {
        alert('Please log in to continue');
        window.location.href = '/login';
        return;
      }

      const user = JSON.parse(userData);

      // Check if Stripe is initialized
      if (!stripe || !cardElement) {
        alert('Payment system is still loading. Please wait a moment and try again.');
        return;
      }

      // Get form data
      const email = document.getElementById('email').value;

      // Disable submit button
      const submitBtn = document.querySelector('.submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing Payment...';

      try {
        // Step 1: Create Payment Intent
        const paymentIntentResponse = await fetch('/api/create-payment-intent', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            subscriptionType: plan,
            email: email
          })
        });

        if (!paymentIntentResponse.ok) {
          const error = await paymentIntentResponse.json();
          throw new Error(error.error || 'Failed to create payment intent');
        }

        const { clientSecret, amount } = await paymentIntentResponse.json();

        // Step 2: Confirm payment with Stripe
        const { error: stripeError, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
          payment_method: {
            card: cardElement,
            billing_details: {
              email: email
            }
          }
        });

        if (stripeError) {
          throw new Error(stripeError.message);
        }

        if (paymentIntent.status !== 'succeeded') {
          throw new Error('Payment was not successful. Please try again.');
        }

        // Step 3: Payment succeeded - now extend subscription
        const formData = {
          email: email,
          subscriptionType: plan,
          paymentMethod: 'card',
          isExtension: true,
          stripePaymentIntentId: paymentIntent.id
        };

        const response = await fetch('/api/extend-subscription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (response.ok) {
          alert(`Success! ${result.message}\n\nYour subscription is now active until ${new Date(result.subscriptionEnd).toLocaleDateString()}`);

          // Redirect to seller dashboard
          window.location.href = '/seller-dashboard';
        } else {
          alert(`Error: ${result.error}`);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Complete Payment & Extend Subscription';
        }
      } catch (error) {
        console.error('Payment error:', error);
        alert(`Payment failed: ${error.message}\n\nPlease try again.`);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Complete Payment & Extend Subscription';
      }
    });
  </script>
</body>
</html>
