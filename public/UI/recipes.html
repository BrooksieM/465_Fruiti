<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recipes ‚Ä¢ Fruiti</title>
  <link rel="stylesheet" href="../css/standardLayout.css">
  <link rel="stylesheet" href="../css/footer/footer.css">
  <link rel="stylesheet" href="../css/RecipePage/recipe.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
  <!-- Top Navigation Bar (same structure as Become Seller / About Us) -->
  <div class="navbar">
    <div class="logo">
      <img src="../images/fruiti.png" alt="Fruiti Logo" />
    </div>

    <div class="search-bar">
      <input type="text" placeholder="Search Fruit" />
    </div>

    <div class="auth-buttons" id="authButtons">
      <!-- Default state - show login/signup -->
      <button class="login-btn" onclick="location.href='/login'">Log In</button>
      <button class="signup-btn" onclick="location.href='/signup'">Sign Up</button>
    </div>
  </div>

  <!-- Main nav links bar -->
  <nav class="nav-links">
    <a href="/">Home</a>
    <a href="/become-seller">Become a Seller</a>
    <a href="nutrition">Nutrition</a>
    <a href="recipes.html" class="active">Recipes</a>
    <a href="/aboutus">About Us</a>
  </nav>

  <!-- Black bar under nav (for consistent layout) -->
  <div class="black-bar"></div>

  <!-- Hero Section -->
  <section class="recipe-hero">
    <h1>Discover Delicious Recipes üçé</h1>
    <p>
      Explore our collection of healthy, fruit-based recipes. From quick snacks to gourmet desserts,
      find your next favorite dish!
    </p>
  </section>

  <!-- Main Content -->
  <main class="recipe-page">
    <div class="page-container">
      
      <!-- Left Sidebar - Filters -->
      <aside class="filter-sidebar">
        <div class="filter-header">
          <h3>Filters</h3>
          <button class="clear-filters" id="clearFilters">Clear</button>
        </div>
        
        <!-- Difficulty Filter -->
        <div class="filter-section">
          <h4>Difficulty</h4>
          <div class="filter-options">
            <label class="filter-checkbox">
              <input type="checkbox" name="difficulty" value="easy" class="filter-input" />
              <span class="checkbox-custom"></span>
              <span class="checkbox-label">Easy</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" name="difficulty" value="medium" class="filter-input" />
              <span class="checkbox-custom"></span>
              <span class="checkbox-label">Medium</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" name="difficulty" value="hard" class="filter-input" />
              <span class="checkbox-custom"></span>
              <span class="checkbox-label">Hard</span>
            </label>
          </div>
        </div>
        
        <!-- Time Filter -->
        <div class="filter-section">
          <h4>Time</h4>
          <div class="filter-options">
            <label class="filter-checkbox">
              <input type="checkbox" name="time" value="0-15" class="filter-input" />
              <span class="checkbox-custom"></span>
              <span class="checkbox-label">Under 15 min</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" name="time" value="15-30" class="filter-input" />
              <span class="checkbox-custom"></span>
              <span class="checkbox-label">15-30 min</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" name="time" value="30-60" class="filter-input" />
              <span class="checkbox-custom"></span>
              <span class="checkbox-label">30-60 min</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" name="time" value="60+" class="filter-input" />
              <span class="checkbox-custom"></span>
              <span class="checkbox-label">Over 60 min</span>
            </label>
          </div>
        </div>
        
        <!-- Season Filter -->
        <div class="filter-section">
          <h4>Season</h4>
          <div class="filter-options">
            <label class="filter-checkbox">
              <input type="checkbox" name="season" value="spring" class="filter-input" />
              <span class="checkbox-custom"></span>
              <span class="checkbox-label">Spring</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" name="season" value="summer" class="filter-input" />
              <span class="checkbox-custom"></span>
              <span class="checkbox-label">Summer</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" name="season" value="fall" class="filter-input" />
              <span class="checkbox-custom"></span>
              <span class="checkbox-label">Fall</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" name="season" value="winter" class="filter-input" />
              <span class="checkbox-custom"></span>
              <span class="checkbox-label">Winter</span>
            </label>
          </div>
        </div>
      </aside>
      
      <!-- Right Content Area -->
      <section class="content-area">
        <div class="content-header">
          <div>
            <h1>Featured Recipes</h1>
            <p class="subtitle">Fresh ideas for every meal and occasion</p>
          </div>
          <button class="btn-create" id="openCreateModal">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Create Recipe
          </button>
        </div>
        
        <!-- Recipe Grid -->
        <div id="cards" class="recipe-grid"></div>
      </section>
    </div>
  </main>

  <!-- Create Recipe Modal -->
  <div class="modal" id="createModal" hidden>
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Create a New Recipe</h2>
          <button class="modal-close" id="closeCreateModal" aria-label="Close">√ó</button>
        </div>
        
        <form id="createRecipeForm">
          <div class="form-row">
            <div class="form-group">
              <label for="rTitle">Recipe Title</label>
              <input id="rTitle" type="text" placeholder="e.g., Summer Berry Salad" required />
            </div>
            <div class="form-group">
              <label for="rDiff">Difficulty</label>
              <select id="rDiff" required>
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="hard">Hard</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="rServ">Servings</label>
              <input id="rServ" type="number" min="1" placeholder="4" />
            </div>
            <div class="form-group">
              <label for="rMin">Time (minutes)</label>
              <input id="rMin" type="number" placeholder="30" required />
            </div>
          </div>
          
          <div class="form-group">
            <label for="rSummary">Short Description</label>
            <textarea id="rSummary" rows="3" placeholder="Brief description of your recipe" required></textarea>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="rCover">Cover Image URL</label>
              <input id="rCover" type="text" placeholder="https://..." />
            </div>
            <div class="form-group">
              <label for="rCoverFile">Or Upload Image</label>
              <input id="rCoverFile" type="file" accept="image/*" />
            </div>
          </div>
          
          <div class="form-group">
            <label for="rIngr">Ingredients</label>
            <textarea id="rIngr" rows="5" placeholder="Enter ingredients (one per line)" required></textarea>
          </div>
          
          <div class="form-group">
            <label for="rSteps">Instructions</label>
            <textarea id="rSteps" rows="6" placeholder="Enter cooking steps (one per line)" required></textarea>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn-cancel" id="cancelCreate">Cancel</button>
            <button type="submit" class="btn-submit">Create Recipe</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div id="footer-placeholder"></div>
  <script src="../scripts/footer.js"></script>

  <!-- Recipe page logic: load recipes, render cards, handle create form, filters, and modal -->
  <script>
    (function () {
      const API = '/api/recipes';

      const els = {
        grid: document.getElementById('cards'),
        form: document.getElementById('createRecipeForm'),
        title: document.getElementById('rTitle'),
        difficulty: document.getElementById('rDiff'),
        servings: document.getElementById('rServ'),
        minutes: document.getElementById('rMin'),
        summary: document.getElementById('rSummary'),
        coverText: document.getElementById('rCover'),
        coverFile: document.getElementById('rCoverFile'),
        ingredients: document.getElementById('rIngr'),
        steps: document.getElementById('rSteps'),
        openCreate: document.getElementById('openCreateModal'),
        closeCreate: document.getElementById('closeCreateModal'),
        cancelCreate: document.getElementById('cancelCreate'),
        clearFilters: document.getElementById('clearFilters')
      };

      if (!els.grid) return;

      let hasTimeData = false;

      function escapeHtml(str) {
        return String(str || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function buildStars(rating) {
        const r = Number(rating || 0);
        let html = '';
        for (let i = 1; i <= 5; i++) {
          const filled = r >= i;
          html += '<span class="star">' + (filled ? '‚òÖ' : '‚òÜ') + '</span>';
        }
        return html;
      }

      function difficultyClass(diff) {
        const s = String(diff || 'easy').toLowerCase();
        if (s === 'hard') return 'hard';
        if (s === 'medium') return 'medium';
        return 'easy';
      }

      function createRecipeCard(recipe) {
        const diffClass = difficultyClass(recipe.difficulty);
        const minutes = Number(recipe.minutes || 0);
        const servings = Number(recipe.servings || 0);

        let coverUrl = (recipe.coverUrl || '').trim();
        if (!coverUrl) {
          coverUrl = '/images/recipes/1762442126478-butter-chicken-recipe.jpg';
        }

        const card = document.createElement('article');
        card.className = 'recipe-card ' + diffClass;
        card.dataset.id = recipe.id || '';
        card.dataset.time = minutes || 0;

        card.innerHTML = `
          <div class="recipe-card-image">
            <img src="${escapeHtml(coverUrl)}"
                 alt="${escapeHtml(recipe.title || 'Recipe image')}"
                 onerror="this.style.display='none'">
          </div>
          <div class="recipe-card-content">
            <h3 class="recipe-card-title">${escapeHtml(recipe.title || 'Untitled recipe')}</h3>
            <p class="recipe-card-description">${escapeHtml(recipe.summary || '')}</p>
            <div class="recipe-card-meta">
              <div class="meta-item">
                <span class="icon">‚è±</span>
                <span>${minutes > 0 ? minutes + ' min' : 'Time varies'}</span>
              </div>
              <div class="meta-item">
                <span class="icon">üçΩ</span>
                <span>${servings > 0 ? servings + ' servings' : 'Flexible servings'}</span>
              </div>
            </div>
            <div class="recipe-card-rating">
              <div class="stars">
                ${buildStars(recipe.rating)}
              </div>
              <span class="rating-count">
                ${(Number(recipe.rating || 0)).toFixed(1)} / 5
              </span>
            </div>
          </div>
        `;

        return card;
      }

      function applyFilters() {
        const diffChecks = Array.from(
          document.querySelectorAll('input[name="difficulty"]:checked')
        ).map(x => x.value.toLowerCase());

        const timeChecks = Array.from(
          document.querySelectorAll('input[name="time"]:checked')
        ).map(x => x.value);

        const cards = els.grid.querySelectorAll('.recipe-card');

        cards.forEach(card => {
          let show = true;

          if (diffChecks.length > 0) {
            const hasDiff = diffChecks.some(d => card.classList.contains(d));
            if (!hasDiff) show = false;
          }

          if (show && timeChecks.length > 0 && hasTimeData) {
            const t = Number(card.dataset.time || 0);
            let ok = false;
            for (const window of timeChecks) {
              if (window === '0-15' && t > 0 && t <= 15) ok = true;
              else if (window === '15-30' && t > 15 && t <= 30) ok = true;
              else if (window === '30-60' && t > 30 && t <= 60) ok = true;
              else if (window === '60+' && t > 60) ok = true;
            }
            if (!ok) show = false;
          }

          card.style.display = show ? '' : 'none';
        });
      }

      async function loadRecipes() {
        try {
          const res = await fetch(API);
          if (!res.ok) {
            console.error('Failed to load recipes:', await res.text());
            return;
          }

          const items = await res.json();
          els.grid.innerHTML = '';

          let cardsWithTime = 0;

          (items || []).forEach(r => {
            const card = createRecipeCard(r);
            if (card.dataset.time && Number(card.dataset.time) > 0) {
              cardsWithTime++;
            }
            els.grid.appendChild(card);
          });

          hasTimeData = cardsWithTime > 0;
          applyFilters();
        } catch (err) {
          console.error('Error loading recipes:', err);
        }
      }

      async function handleCreate(e) {
        e.preventDefault();

        if (!els.form) return;

        const title = (els.title.value || '').trim();
        const summary = (els.summary.value || '').trim();
        const difficulty = (els.difficulty.value || '').trim();
        const servings = parseInt(els.servings.value || '0', 10) || null;
        const minutes = parseInt(els.minutes.value || '0', 10) || null;

        const ingredientsText = (els.ingredients.value || '').trim();
        const stepsText = (els.steps.value || '').trim();

        if (!title || !ingredientsText || !stepsText) {
          alert('Please fill in the title, ingredients, and instructions.');
          return;
        }

        let coverUrl = (els.coverText.value || '').trim();
        const file = els.coverFile && els.coverFile.files && els.coverFile.files[0];

        if (!coverUrl && file) {
          try {
            coverUrl = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
          } catch (err) {
            console.warn('Could not read file, continuing without cover image:', err);
          }
        }

        const payload = {
          title,
          summary,
          difficulty,
          servings,
          minutes,
          ingredients: ingredientsText,
          steps: stepsText,
          coverUrl
        };

        try {
          const res = await fetch(API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            const txt = await res.text();
            console.error('Create recipe failed:', txt);
            alert('Could not create recipe. See console for details.');
            return;
          }

          els.form.reset();
          if (els.coverFile) els.coverFile.value = '';

          const modal = document.getElementById('createModal');
          if (modal) {
            modal.hidden = true;
            document.body.style.overflow = '';
          }

          await loadRecipes();
        } catch (err) {
          console.error('Error creating recipe:', err);
          alert('An unexpected error occurred while creating the recipe.');
        }
      }

      function wireModal() {
        const modal = document.getElementById('createModal');

        if (!modal) return;

        function openModal() {
          modal.hidden = false;
          document.body.style.overflow = 'hidden';
        }

        function closeModal() {
          modal.hidden = true;
          document.body.style.overflow = '';
        }

        if (els.openCreate) {
          els.openCreate.addEventListener('click', openModal);
        }

        if (els.closeCreate) {
          els.closeCreate.addEventListener('click', closeModal);
        }

        if (els.cancelCreate) {
          els.cancelCreate.addEventListener('click', closeModal);
        }

        modal.addEventListener('click', (e) => {
          if (e.target === modal) closeModal();
        });
      }

      function wireFilters() {
        document.querySelectorAll('.filter-input').forEach(checkbox => {
          checkbox.addEventListener('change', () => {
            setTimeout(applyFilters, 50);
          });
        });

        if (els.clearFilters) {
          els.clearFilters.addEventListener('click', () => {
            document
              .querySelectorAll('.filter-checkbox input[type="checkbox"]')
              .forEach(cb => { cb.checked = false; });
            applyFilters();
          });
        }
      }

      function initAuthGate() {
        try {
          const user = JSON.parse(localStorage.getItem('user') || 'null');
          if (!user && els.openCreate) {
            els.openCreate.style.display = 'none';
          }
        } catch (e) {
          console.warn('Could not read user from localStorage', e);
        }
      }

      if (els.form) {
        els.form.addEventListener('submit', handleCreate);
      }

      wireModal();
      wireFilters();
      initAuthGate();
      loadRecipes();

      window.refresh = loadRecipes;
    })();
  </script>
  <script src="/scripts/navigationForLoggedInUser.js"></script>
</body>
</html>
