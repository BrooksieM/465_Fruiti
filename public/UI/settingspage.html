<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Account Settings - Fruiti</title>
<link rel="stylesheet" href="../css/standardLayout.css">
<link rel="stylesheet" href="../css/SettingsPage/settingspage.css">
</head>

<body>
  <div class="navbar">
    <div class="logo">
      <img src="../images/fruiti.png" alt="Fruiti Logo" />
    </div>
    <div class="search-bar">
      <input type="text" placeholder="Search Fruit" />
    </div>
    <div class="auth-buttons">
      <button onclick="location.href='/login'" class="login-btn">Log In</button>
      <button onclick="location.href='/signup'" class="signup-btn">Sign Up</button>
    </div>
  </div>

  <nav class="nav-links">
    <a href="/">Home</a>
    <a href="become-seller.html">Become a Seller</a>
    <a href="nutrition.html">Nutrition</a>
    <a href="recipe.html">Recipes</a>
    <a href="about-us.html">About Us</a>
  </nav>

  <div class="black-bar"></div>

  <!-- Main Content -->
  <div class="page-layout">
    <div class="settings-container">
      <!-- Sidebar Navigation -->
      <div class="settings-sidebar">
        <div class="settings-header">
          <h1>Account Settings</h1>
          <p>Manage your Fruiti account preferences</p>
        </div>
        
        <div class="settings-nav">
          <button class="nav-btn active" data-tab="profile">Profile</button>
          <button class="nav-btn" data-tab="security">Security</button>
          <button class="nav-btn" data-tab="notifications">Notifications</button>
          <button class="nav-btn" data-tab="danger">Danger Zone</button>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="settings-main">
        <!-- Error/Success Messages -->
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        <div id="successMessage" class="success-message" style="display: none;"></div>

        <!-- Profile Tab -->
        <div class="settings-tab active" id="profile-tab">
          <div class="tab-header">
            <h2>Profile Information</h2>
            <p>Update your personal details and profile picture</p>
          </div>
          
          <form class="settings-form" id="profileForm">
            <div class="avatar-section">
              <div class="avatar-preview">
                <img src="/images/default-avatar.png" alt="Profile Avatar" id="avatarPreview">
              </div>
              <div class="avatar-actions">
                <button type="button" class="avatar-btn" onclick="document.getElementById('avatarUpload').click()">
                  Upload New Photo
                </button>
                <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                <button type="button" class="avatar-btn remove-btn">Remove Photo</button>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="displayName">Display Name</label>
                <input type="text" id="displayName" name="displayName" placeholder="Enter your display name" />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" placeholder="Choose a username" />
                <small>This is your unique identifier on Fruiti</small>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" placeholder="Enter your email" />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="bio">Bio</label>
                <textarea id="bio" name="bio" placeholder="Tell us about yourself..." rows="4"></textarea>
                <small>Brief description about yourself (max 200 characters)</small>
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="save-btn">
                <span class="btn-text">Save Changes</span>
                <span class="btn-loading" style="display: none;">Saving...</span>
              </button>
              <button type="button" class="cancel-btn" onclick="resetForm()">Cancel</button>
            </div>
          </form>
        </div>

        <!-- Security Tab -->
        <div class="settings-tab" id="security-tab">
          <div class="tab-header">
            <h2>Security Settings</h2>
            <p>Manage your password and account security</p>
          </div>
          
          <form class="settings-form" id="securityForm">
            <div class="form-row">
              <div class="form-group">
                <label for="currentPassword">Current Password</label>
                <input type="password" id="currentPassword" name="currentPassword" placeholder="Enter current password" required />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" name="newPassword" placeholder="Enter new password" required minlength="6" />
                <div class="password-strength">
                  <div class="strength-bar" id="securityStrengthBar"></div>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="confirmNewPassword">Confirm New Password</label>
                <input type="password" id="confirmNewPassword" name="confirmNewPassword" placeholder="Confirm new password" required />
              </div>
            </div>

            <div class="security-options">
              <h3>Additional Security</h3>
              <div class="checkbox-group">
                <input type="checkbox" id="twoFactor" name="twoFactor">
                <label for="twoFactor">Enable Two-Factor Authentication</label>
              </div>
              <div class="checkbox-group">
                <input type="checkbox" id="loginAlerts" name="loginAlerts" checked>
                <label for="loginAlerts">Send login alert emails</label>
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="save-btn">
                <span class="btn-text">Update Password</span>
                <span class="btn-loading" style="display: none;">Updating...</span>
              </button>
            </div>
          </form>
        </div>

        <!-- Notifications Tab -->
        <div class="settings-tab" id="notifications-tab">
          <div class="tab-header">
            <h2>Notification Settings</h2>
            <p>Choose how you want to be notified</p>
          </div>
          
          <form class="settings-form" id="notificationsForm">
            <div class="notification-section">
              <h3>Email Notifications</h3>
              <div class="checkbox-group">
                <input type="checkbox" id="emailRecipes" name="emailRecipes" checked>
                <label for="emailRecipes">New recipe recommendations</label>
              </div>
              <div class="checkbox-group">
                <input type="checkbox" id="emailNutrition" name="emailNutrition" checked>
                <label for="emailNutrition">Nutrition tips and updates</label>
              </div>
              <div class="checkbox-group">
                <input type="checkbox" id="emailPromotions" name="emailPromotions">
                <label for="emailPromotions">Promotional offers</label>
              </div>
            </div>

            <div class="notification-section">
              <h3>Push Notifications</h3>
              <div class="checkbox-group">
                <input type="checkbox" id="pushComments" name="pushComments" checked>
                <label for="pushComments">New comments on my recipes</label>
              </div>
              <div class="checkbox-group">
                <input type="checkbox" id="pushLikes" name="pushLikes" checked>
                <label for="pushLikes">Likes on my content</label>
              </div>
              <div class="checkbox-group">
                <input type="checkbox" id="pushFruitStands" name="pushFruitStands">
                <label for="pushFruitStands">New fruit stands nearby</label>
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="save-btn">
                <span class="btn-text">Update Notifications</span>
                <span class="btn-loading" style="display: none;">Updating...</span>
              </button>
            </div>
          </form>
        </div>

        <!-- Danger Zone Tab -->
        <div class="settings-tab" id="danger-tab">
          <div class="tab-header">
            <h2>Danger Zone</h2>
            <p>Irreversible and destructive actions</p>
          </div>
          
          <div class="settings-form">
            <div class="danger-zone">
              <h3>Sign Out</h3>
              <p>Sign out of your account on this device</p>
              <button class="logout-btn" onclick="logout()">Sign Out</button>

              <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #ff8182;">
                <h3 style="color: #d1242f;">Delete Account</h3>
                <p>Permanently delete your account and all associated data. This action cannot be undone.</p>
                <button class="delete-btn" onclick="showDeleteConfirmation()">Delete Account</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="deleteModal" style="display: none;">
    <div class="modal-container">
      <div class="modal-header">
        <h2>Delete Account</h2>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete your account? This action cannot be undone.</p>
        <div class="modal-actions">
          <button class="confirm-delete-btn" onclick="deleteAccount()">Yes, Delete My Account</button>
          <button class="cancel-delete-btn" onclick="hideDeleteConfirmation()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
// User data management
let originalUserData = null;

// Debug function
function debugUserData() {
    console.log('=== DEBUG: Checking localStorage ===');
    const userData = localStorage.getItem('user');
    
    if (!userData) {
        console.log('‚ùå No user data found in localStorage');
        return null;
    }
    
    try {
        const user = JSON.parse(userData);
        console.log('‚úÖ User data found:', user);
        console.log('üîë User ID:', user.id);
        console.log('üìã All user properties:', Object.keys(user));
        return user;
    } catch (error) {
        console.log('‚ùå Error parsing user data:', error);
        return null;
    }
}

// Navigation functions
function updateNavigationForLoggedInUser(user) {
    const authButtons = document.querySelector('.auth-buttons');
    
    if (user && user.id) {
        authButtons.innerHTML = `
            <div class="user-welcome">
                <span class="welcome-text">Hi, ${user.username || user.handle || 'User'}</span>
                <button class="settings-btn" onclick="goToSettings()">‚öôÔ∏è Settings</button>
            </div>
        `;
    }
}

function goToSettings() {
    location.href='/settings';
}

// Authentication
function checkAuthStatus() {
    console.log('üîç Checking authentication status...');
    
    const user = debugUserData();
    
    if (user && user.id) {
        console.log('‚úÖ User is authenticated with ID:', user.id);
        updateNavigationForLoggedInUser(user);
        initializeFormWithUserData(user);
    } else {
        console.log('‚ùå User not authenticated, redirecting to login...');
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 1000);
    }
}

// Form management
function initializeFormWithUserData(user) {
    console.log('üìù Initializing form with user data:', user);
    
    // Store original data for cancel functionality
    originalUserData = { ...user };
    
    const fieldMappings = {
        'displayName': user.displayName || user.name || user.handle || '',
        'username': user.handle || user.username || '',
        'email': user.email || '',
        'bio': user.bio || 'I love fresh fruits and healthy recipes!'
    };

    Object.entries(fieldMappings).forEach(([fieldId, value]) => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = value;
            console.log(`‚úÖ Set ${fieldId} to:`, value);
        }
    });

    // Update avatar if available
    if (user.avatar) {
        const avatarPreview = document.getElementById('avatarPreview');
        if (avatarPreview) {
            avatarPreview.src = user.avatar;
        }
    }
}

function resetForm() {
    if (originalUserData) {
        initializeFormWithUserData(originalUserData);
        showSuccess('Changes discarded');
    }
}

// PUT endpoint integration for profile updates
async function updateUserProfile(userId, formData) {
    console.log('üì§ Updating user profile:', { userId, formData });

    try {
        const response = await fetch(`/api/accounts/${userId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        const responseData = await response.json();
        
        if (!response.ok) {
            throw new Error(responseData.error || `HTTP error! status: ${response.status}`);
        }

        console.log('‚úÖ Profile update successful:', responseData);
        return responseData;
        
    } catch (error) {
        console.error('‚ùå Profile update failed:', error);
        throw error;
    }
}

// Profile form submission with PUT endpoint
document.getElementById('profileForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    console.log('üîÑ Profile form submitted');
    
    const user = debugUserData();
    if (!user || !user.id) {
        showError('Please log in to update your profile');
        return;
    }

    const submitBtn = this.querySelector('.save-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');

    // Show loading state
    submitBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    hideMessages();

    try {
        const formData = {
            handle: document.getElementById('username').value.trim(),
            email: document.getElementById('email').value.trim(),
            // Note: Add avatar support when you implement file upload
            // avatar: document.getElementById('avatarPreview').src
        };

        // Basic validation
        if (!formData.handle) {
            throw new Error('Username is required');
        }
        if (!formData.email) {
            throw new Error('Email is required');
        }

        const updatedUser = await updateUserProfile(user.id, formData);
        
        // Update localStorage with new user data
        const currentUser = JSON.parse(localStorage.getItem('user'));
        const mergedUser = { 
            ...currentUser, 
            ...updatedUser,
            // Include fields that might not be returned by the API
            handle: formData.handle,
            email: formData.email
        };
        localStorage.setItem('user', JSON.stringify(mergedUser));
        
        // Update navigation with new username
        updateNavigationForLoggedInUser(mergedUser);
        
        // Update original data for cancel functionality
        originalUserData = { ...mergedUser };
        
        showSuccess('Profile updated successfully!');

    } catch (error) {
        console.error('‚ùå Profile update error:', error);
        showError('Error updating profile: ' + error.message);
    } finally {
        // Reset button state
        submitBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
    }
});

// Message helpers
function showSuccess(message) {
    const successElement = document.getElementById('successMessage');
    const errorElement = document.getElementById('errorMessage');
    
    if (errorElement) errorElement.style.display = 'none';
    if (successElement) {
        successElement.textContent = message;
        successElement.style.display = 'block';
        
        setTimeout(() => {
            successElement.style.display = 'none';
        }, 5000);
    }
}

function showError(message) {
    const successElement = document.getElementById('successMessage');
    const errorElement = document.getElementById('errorMessage');
    
    if (successElement) successElement.style.display = 'none';
    if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
    }
}

function hideMessages() {
    const successElement = document.getElementById('successMessage');
    const errorElement = document.getElementById('errorMessage');
    
    if (successElement) successElement.style.display = 'none';
    if (errorElement) errorElement.style.display = 'none';
}

// Logout function
function logout() {
    console.log('üö™ Logging out...');
    localStorage.removeItem('user');
    window.location.href = 'index.html';
}

// Tab Navigation
document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // Remove active class from all buttons and tabs
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.settings-tab').forEach(tab => tab.classList.remove('active'));
        
        // Add active class to clicked button
        this.classList.add('active');
        
        // Show corresponding tab
        const tabId = this.getAttribute('data-tab') + '-tab';
        document.getElementById(tabId).classList.add('active');
        
        // Hide messages when switching tabs
        hideMessages();
    });
});

// Password strength indicator
document.getElementById('newPassword')?.addEventListener('input', function() {
    const password = this.value;
    const strengthBar = document.getElementById('securityStrengthBar');
    let strength = 0;
    
    if (password.length >= 6) strength += 1;
    if (password.length >= 8) strength += 1;
    if (/[A-Z]/.test(password)) strength += 1;
    if (/[0-9]/.test(password)) strength += 1;
    if (/[^A-Za-z0-9]/.test(password)) strength += 1;
    
    strengthBar.className = 'strength-bar';
    if (password.length === 0) {
        strengthBar.style.width = '0%';
    } else if (strength <= 2) {
        strengthBar.classList.add('strength-weak');
    } else if (strength <= 4) {
        strengthBar.classList.add('strength-medium');
    } else {
        strengthBar.classList.add('strength-strong');
    }
});

// Password confirmation validation
document.getElementById('confirmNewPassword')?.addEventListener('input', function() {
    const password = document.getElementById('newPassword').value;
    const confirmPassword = this.value;

    if (confirmPassword && password !== confirmPassword) {
        showError('Passwords do not match');
    } else if (confirmPassword && password === confirmPassword) {
        hideMessages();
    }
});

// Other form submissions (security, notifications)
document.querySelectorAll('.settings-form').forEach(form => {
    if (form.id !== 'profileForm') {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('.save-btn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');

            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            hideMessages();

            try {
                // Simulate API call for other forms
                await new Promise(resolve => setTimeout(resolve, 1000));
                showSuccess('Settings updated successfully!');
            } catch (error) {
                showError('Error updating settings. Please try again.');
            } finally {
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
            }
        });
    }
});

// Avatar upload preview
document.getElementById('avatarUpload')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            showError('Image size must be less than 5MB');
            return;
        }
        
        // Check file type
        if (!file.type.startsWith('image/')) {
            showError('Please select an image file');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('avatarPreview').src = e.target.result;
            showSuccess('Avatar updated! Click "Save Changes" to make it permanent.');
        };
        reader.readAsDataURL(file);
    }
});

// Remove avatar
document.querySelector('.remove-btn')?.addEventListener('click', function() {
    document.getElementById('avatarPreview').src = '/images/default-avatar.png';
    showSuccess('Avatar removed! Click "Save Changes" to make it permanent.');
});

// Delete account functions
function showDeleteConfirmation() {
    document.getElementById('deleteModal').style.display = 'flex';
}

function hideDeleteConfirmation() {
    document.getElementById('deleteModal').style.display = 'none';
}

function deleteAccount() {
    const user = debugUserData();
    if (!user || !user.id) {
        showError('Please log in to delete your account');
        return;
    }

    console.log('üóëÔ∏è Deleting account:', user.id);
    
    // In a real application, you would call your delete endpoint here
    // fetch(`/api/accounts/${user.id}`, { method: 'DELETE' })
    
    // For now, simulate deletion
    setTimeout(() => {
        localStorage.removeItem('user');
        hideDeleteConfirmation();
        alert('Account deletion would be implemented here. Redirecting to home page...');
        window.location.href = 'index.html';
    }, 1000);
}

// Enhanced input focus for better UX
document.querySelectorAll('.form-group input, .form-group textarea').forEach(input => {
    input.addEventListener('focus', function() {
        this.parentElement.classList.add('focused');
    });
    
    input.addEventListener('blur', function() {
        this.parentElement.classList.remove('focused');
    });
});

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Settings page loaded');
    checkAuthStatus();
    
    // Add keyboard shortcut for cancel (ESC)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            resetForm();
        }
    });
});

// Utility function to validate email format
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// Enhanced form validation for profile form
document.getElementById('profileForm').addEventListener('input', function(e) {
    const email = document.getElementById('email').value;
    const username = document.getElementById('username').value;
    
    if (email && !isValidEmail(email)) {
        showError('Please enter a valid email address');
    } else if (username && username.length < 3) {
        showError('Username must be at least 3 characters long');
    } else {
        hideMessages();
    }
});
</script>
</body>
</html>